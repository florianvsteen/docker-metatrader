version: "3.9"

# ================================================================
# MetaTrader 5 — Headless + VNC, Bottles (Arch Linux native)
#
# Before deploying in Portainer, build on the host:
#   cd /opt/stacks/mt5-headless
#   docker compose build
#
# Then Portainer → Stacks → Add Stack → Upload this file.
# ================================================================

services:
  metatrader5:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: metatrader5
    hostname: metatrader5

    environment:
      - MT5_SERVER=Demo.ICMarkets.com:443
      - MT5_LOGIN=123456
      - MT5_PASSWORD=YourPasswordHere
      - VNC_PASSWORD=trader123
      - VNC_PORT=5901
      - NOVNC_PORT=6080

    ports:
      - "6080:6080"
      - "5901:5901"

    volumes:
      # Bottles data — Wine prefix + MT5 installation
      - bottles_data:/home/trader/.local/share/bottles
      # First-run flag
      - mt5_state:/home/trader/.bottles_ready
      # EAs / Scripts / Indicators
      - ./mql5/Experts:/home/trader/mt5-data/MQL5/Experts
      - ./mql5/Scripts:/home/trader/mt5-data/MQL5/Scripts
      - ./mql5/Indicators:/home/trader/mt5-data/MQL5/Indicators
      # Logs
      - ./logs:/home/trader/mt5-data/logs

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    healthcheck:
      test: ["CMD", "pgrep", "-f", "terminal64.exe"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  bottles_data:
    name: mt5_bottles_data
  mt5_state:
    name: mt5_state
