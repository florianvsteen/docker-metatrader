[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=warn

# ── Virtual display ───────────────────────────────────────────
[program:xvfb]
command=Xvfb :99 -screen 0 1280x800x24 -nolisten tcp
priority=10
autorestart=true
stdout_logfile=/dev/null
stderr_logfile=/dev/null

# ── Window manager (so MT5 windows render correctly) ──────────
[program:fluxbox]
command=fluxbox
environment=DISPLAY=":99",HOME="/home/trader",USER="trader"
user=trader
priority=20
startsecs=2
autorestart=true
stdout_logfile=/dev/null
stderr_logfile=/dev/null

# ── VNC server (view-only by default, change -viewonly to allow input) ──
[program:x11vnc]
command=x11vnc
    -display :99
    -rfbauth /etc/vnc/passwd
    -rfbport %(ENV_VNC_PORT)s
    -forever
    -shared
    -noxdamage
    -noxfixes
    -viewonly
priority=30
startsecs=3
autorestart=true
stdout_logfile=/dev/null
stderr_logfile=/var/log/supervisor/x11vnc.err

# ── noVNC web client (browser access) ────────────────────────
[program:novnc]
command=/usr/share/novnc/utils/novnc_proxy
    --vnc localhost:%(ENV_VNC_PORT)s
    --listen %(ENV_NOVNC_PORT)s
priority=40
startsecs=4
autorestart=true
stdout_logfile=/dev/null
stderr_logfile=/dev/null

# ── MT5 startup script ────────────────────────────────────────
# Runs entrypoint logic (first-run setup + MT5 launch) as trader user
[program:mt5]
command=/home/trader/scripts/mt5-start.sh
environment=DISPLAY=":99",HOME="/home/trader",USER="trader"
user=trader
priority=50
startsecs=10
autorestart=true
stdout_logfile=/proc/1/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/proc/1/fd/2
stderr_logfile_maxbytes=0
